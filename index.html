<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Emissions Analysis</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    
    <h1> How Do Vehicle Features and Fuel Consumption Affect <br> CO2 Emissions in Passenger Vehicles?</h1>

    <h3>Introduction</h3>

    <p>The transportation sector plays a big role in global CO2 emissions, which are a major factor in climate change. As countries work to reduce greenhouse gas emissions, it is important to understand what affects CO2 emissions from vehicles. This dataset gives us a detailed look at vehicle features, fuel consumption, and CO2 emissions over a span of several years, including various features of such vehicles.</p>

    <p>By examining this data, we aim to identify trends and correlations that could inform more sustainable vehicle design and consumer choices. The exploration of how fuel types, vehicle configurations, and fuel efficiency contribute to emissions is not only scientifically interesting but also essential for shaping policies that aim to reduce the environmental impact of personal transportation.</p>

    <h3>References</h3>

    <ul>
        <li>Goodwin, P., Dargay, J., & Hanly, M. (2004). Decomposition of factors determining the trend of CO2 emissions from car travel in Great Britain (1970–2000). Ecological Economics, 51(2-3), 257-272. <a href="https://doi.org/10.1016/j.ecolecon.2004.06.015">https://doi.org/10.1016/j.ecolecon.2004.06.015</a></li>
        <li>Schipper, L., Marie-Lilliu, C., & Gorham, R. (2003). CO2 emission benefit of diesel (versus gasoline) powered vehicles. Environmental Science & Technology, 37(17), 3758-3762. <a href="https://doi.org/10.1021/es034928d">https://doi.org/10.1021/es034928d</a></li>
    </ul>

    <h3>Relevant Images</h3>

    <p>The following images illustrate trends and impacts of CO2 emissions in vehicles, referencing the analysis by  <a href="https://www.jato.com/resources/media-and-press-releases/increased-demand-for-evs-in-2020-contributed-to-a-12-fall-in-europes-average-co2-emissions/">JATO</a> (2021):</p>

    <figure style="margin-bottom: 20px;">
        <img src="./image1.png" alt="CO2 Emissions Trend 1" style="width: 60%; display: block; margin: 0 auto;" />
        <figcaption style="margin-top: 10px;">Figure 1: Volume Weighted Average CO2 Emissions (g/km) by Segment.</figcaption>
    </figure>
    
    <figure style="margin-bottom: 20px;">
        <img src="./image2.png" alt="CO2 Emissions Trend 2" style="width: 60%; display: block; margin: 0 auto;" />
        <figcaption style="margin-top: 10px;">Figure 2: Volume Weighted Average CO2 Emissions (g/km) by Fuel-Type.</figcaption>
    </figure>

    <h3>Data</h3>

    <p>The dataset used in the project captures detailed information on CO2 emissions from vehicles, sourced from the official open data website of the Canadian government. It covers emissions data for cars over a span of seven years. The dataset consists of 7,385 rows and 12 columns, where each row corresponds to a specific car model with different features, and the columns represent attributes such as vehicle type, fuel consumption, engine size, and so on. Here is an overview of our dataset:</p>

    <h3>Data Dictionary</h3>

    <div class="center">
        <table class="tg" style="width: 60%;">
            <thead>
                <tr>
                    <th>Variable Name</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Make</td>
                    <td>The manufacturer of the vehicle</td>
                </tr>
                <tr>
                    <td>Model</td>
                    <td>The model name of the vehicle</td>
                </tr>
                <tr>
                    <td>Vehicle Class</td>
                    <td>Classification of the vehicle based on interior volume for cars and gross vehicle weight rating for light trucks</td>
                </tr>
                <tr>
                    <td>Engine Size (L)</td>
                    <td>Total displacement of all cylinders (in liters)</td>
                </tr>
                <tr>
                    <td>Cylinders</td>
                    <td>Number of engine cylinders</td>
                </tr>
                <tr>
                    <td>Transmission</td>
                    <td>The type of transmission and number of gears/speeds</td>
                </tr>
                <tr>
                    <td>Fuel Type</td>
                    <td>The type of fuel used to power the vehicle</td>
                </tr>
                <tr>
                    <td>Fuel Consumption City (L/100 km)</td>
                    <td>City fuel consumption rating shown in liters per 100 kilometers</td>
                </tr>
                <tr>
                    <td>Fuel Consumption Highway (L/100 km)</td>
                    <td>Highway fuel consumption rating shown in liters per 100 kilometers</td>
                </tr>
                <tr>
                    <td>Fuel Consumption Combined (L/100 km)</td>
                    <td>Combined fuel consumption rating shown in liters per 100 kilometers</td>
                </tr>
                <tr>
                    <td>Fuel Consumption Combined (mpg)</td>
                    <td>The combined rating expressed in miles per imperial gallon</td>
                </tr>
                <tr>
                    <td>CO2 Emissions (g/km)</td>
                    <td>The vehicle’s tailpipe emissions of carbon dioxide shown in grams per kilometer for combined city and highway driving</td>
                </tr>
            </tbody>
        </table>
    </div>

    <h3>Abbreviations</h3>
    <div class="center">
        <table class="tg" style="width: 60%;">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Abbreviation</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Model</td>
                    <td>4WD/4X4 = Four-wheel drive; AWD = All-wheel drive; FFV = Flexible-fuel vehicle; SWB = Short wheelbase; LWB = Long wheelbase; EWB = Extended wheelbase</td>
                </tr>
                <tr>
                    <td>Transmission</td>
                    <td>A = Automatic; AM = Automated manual; AS = Automatic with select shift; AV = Continuously variable; M = Manual; 3 - 10 = Number of gears</td>
                </tr>
                <tr>
                    <td>Fuel Type</td>
                    <td>X = Regular gasoline; Z = Premium gasoline; D = Diesel; E = Ethanol (E85); N = Natural gas</td>
                </tr>
            </tbody>
        </table>
    </div>

    <p>Source: Government of Canada. (n.d.). Vehicle emissions data. Open Government Portal. <a href="https://open.canada.ca/data/en/dataset/98f1a129-f628-4ce4-b24d-6f16bf24dd64">https://open.canada.ca/data/en/dataset/98f1a129-f628-4ce4-b24d-6f16bf24dd64</a></p>

    <h3>Static Visualizations</h3>

    <p>The following static visualizations explore key insights regarding CO2 emissions based on vehicle features:</p>

        <!-- First Visualization: CO2 Emissions by Vehicle Class -->
        <figure style="text-align: center; margin-bottom: 20px;">
            <img src="./average_vehicle class.png" alt="Average CO2 Emissions by Vehicle Class" style="width: 80%; display: block;" />
            <figcaption style="margin-top: 10px;">Figure 1: Average CO2 Emissions by Vehicle Class.</figcaption>
        </figure>

        <!-- Second Visualization: CO2 Emissions vs Engine Size -->
        <figure style="text-align: center; margin-bottom: 20px;">
            <img src="./co2 vs engine size.png" alt="CO2 Emissions vs Engine Size" style="width: 80%; display: block;" />
            <figcaption style="margin-top: 10px;">Figure 2: CO2 Emissions vs Engine Size.</figcaption>
</figure>

<!-- Add this right after your last figure element, before the closing body tag -->

<h3>Interactive Visualization</h3>
<div class="d3-container">
    <h2>Vehicle CO2 Emissions Analysis</h2>
    <div class="controls">
        <select id="metricSelect">
            <option value="average">Average CO2 Emissions</option>
            <option value="lowest">Lowest CO2 Emissions</option>
            <option value="highest">Highest CO2 Emissions</option>
        </select>
        <select id="limitSelect">
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
            <option value="all">All Brands</option>
        </select>
        <button id="sortButton">Toggle Sort</button>
    </div>
    <div id="chart"></div>
</div>

<!-- Add these script tags in the head section of your HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

<!-- Add this script right before the closing body tag -->
<script>
    // Show loading message
    d3.select("#chart")
        .append("div")
        .attr("class", "loading")
        .text("Loading data...");

    // Set up the chart dimensions
    const margin = {top: 40, right: 20, bottom: 60, left: 60};
    const width = 1000 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    // Create tooltip
    const tooltip = d3.select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    // Initialize scales
    const x = d3.scaleBand()
        .range([0, width])
        .padding(0.1);

    const y = d3.scaleLinear()
        .range([height, 0]);

    // Create the SVG container
    const svg = d3.select("#chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Add axes
    const xAxis = svg.append("g")
        .attr("transform", `translate(0,${height})`);

    const yAxis = svg.append("g");

    // Add axis labels
    svg.append("text")
        .attr("class", "axis-label")
        .attr("x", width / 2)
        .attr("y", height + 40)
        .style("text-anchor", "middle")
        .text("Vehicle Make");

    svg.append("text")
        .attr("class", "axis-label")
        .attr("transform", "rotate(-90)")
        .attr("x", -height / 2)
        .attr("y", -40)
        .style("text-anchor", "middle")
        .text("CO2 Emissions (g/km)");

    // Define base color for bars
    const baseColor = "#2ecc71";

    // Function to update the chart
    function updateChart(data, metric = "average", limit = 10, ascending = false) {
        // Validate and clean data
        let processedData = data
            .map(d => ({
                make: d.make,
                value: metric === "average" ? d.avgCO2 :
                       metric === "lowest" ? d.minCO2 :
                       d.maxCO2
            }))
            .filter(d => d.make && !isNaN(d.value) && d.value !== null);

        // Sort and limit data
        processedData.sort((a, b) => ascending ? 
            d3.ascending(a.value || 0, b.value || 0) : 
            d3.descending(a.value || 0, b.value || 0));

        if (limit !== "all") {
            processedData = processedData.slice(0, +limit);
        }

        // Update scales with validation
        x.domain(processedData.map(d => d.make));
        y.domain([0, d3.max(processedData, d => d.value) || 0]);

        // Update axes
        xAxis.call(d3.axisBottom(x))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", "rotate(-45)");

        yAxis.call(d3.axisLeft(y));

        // Update bars
        const bars = svg.selectAll(".bar")
            .data(processedData);

        // Remove old bars
        bars.exit().remove();

        // Add new bars with validation
        const barsEnter = bars.enter()
            .append("rect")
            .attr("class", "bar");

        // Update all bars
        const allBars = bars.merge(barsEnter)
            .transition()
            .duration(1000)
            .attr("x", d => x(d.make))
            .attr("y", d => {
                const yValue = y(d.value);
                return isNaN(yValue) ? y(0) : yValue;
            })
            .attr("width", x.bandwidth())
            .attr("height", d => {
                const height = y(0) - y(d.value);
                return isNaN(height) ? 0 : Math.max(0, height);
            })
            .attr("fill", baseColor);

        // Add hover effects
        svg.selectAll(".bar")
            .on("mouseover", function(event, d) {
                // Dim all bars
                svg.selectAll(".bar")
                    .classed("inactive", true);
                
                // Highlight hovered bar
                d3.select(this)
                    .classed("inactive", false);

                // Show tooltip
                if (d && d.value) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`<strong>${d.make}</strong><br/>CO2: ${d.value.toFixed(1)} g/km`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                }
            })
            .on("mouseout", function(d) {
                // Restore all bars
                svg.selectAll(".bar")
                    .classed("inactive", false);
                
                // Hide tooltip
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
    }

    // Load and process the CSV data
    d3.csv("CO2 Emissions_DS4200.csv").then(function(rawData) {
        // Remove loading message
        d3.select(".loading").remove();

        // Process the data to calculate statistics by make
        const groupedData = d3.group(rawData, d => d.Make);

        const processedData = Array.from(groupedData, ([make, values]) => {
            const validValues = values
                .map(d => parseFloat(d["CO2 Emissions(g/km)"]))
                .filter(v => !isNaN(v));
            
            if (validValues.length > 0) {
                return {
                    make: make,
                    avgCO2: d3.mean(validValues),
                    minCO2: d3.min(validValues),
                    maxCO2: d3.max(validValues)
                };
            }
            return null;
        }).filter(d => d !== null);

        if (processedData.length === 0) {
            console.error("No valid data to display");
            d3.select("#chart")
                .append("div")
                .attr("class", "error")
                .text("No valid data to display. Please check the data format.");
            return;
        }

        // Initial chart render
        updateChart(processedData);

        // Add event listeners
        let ascending = false;
        d3.select("#sortButton").on("click", function() {
            ascending = !ascending;
            updateChart(processedData, 
                       d3.select("#metricSelect").property("value"),
                       d3.select("#limitSelect").property("value"),
                       ascending);
        });

        d3.select("#metricSelect").on("change", function() {
            updateChart(processedData,
                       this.value,
                       d3.select("#limitSelect").property("value"),
                       ascending);
        });

        d3.select("#limitSelect").on("change", function() {
            updateChart(processedData,
                       d3.select("#metricSelect").property("value"),
                       this.value,
                       ascending);
        });

    }).catch(function(error) {
        console.error("Error loading data:", error);
        // Remove loading message and show error
        d3.select(".loading").remove();
        d3.select("#chart")
            .append("div")
            .attr("class", "error")
            .text("Error loading data: " + error.message);
    });
</script>

</body>
</html>
